"use strict";var e=require("@babel/core"),n=require("@babel/helper-plugin-utils"),t=require("@babel/plugin-syntax-jsx"),o=require("@babel/helper-module-imports"),r=require("parse5");function a(e){var n=Object.create(null);return e&&Object.keys(e).forEach((function(t){if("default"!==t){var o=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(n,t,o.get?o:{enumerable:!0,get:function(){return e[t]}})}})),n.default=e,Object.freeze(n)}var i=a(e);function s(e,n){return e.get(`@babel/plugin-pota-jsx/${n}`)}function l(e,n,t){return e.set(`@babel/plugin-pota-jsx/${n}`,t)}const p=(n,t,r)=>l(t,"id/"+r,function(n,t,r){return()=>{let a=s(t,`imports/${r}`);return a?e.types.cloneNode(a):(a=o.addNamed(n,r,"pota/jsx-runtime",{importedInterop:"uncompiled",importPosition:"after"}),l(t,`imports/${r}`,a),a)}}(n,t,r)),c=(n,t,o)=>e.types.callExpression(s(n,`id/${t}`)(),o),u=(n,t)=>e.types.callExpression(e.types.identifier(n),t);function m(e,n){throw e.buildCodeFrameError(n)}function d(e,n){const t=e.buildCodeFrameError(n).toString();console.log(),console.warn(function(e){try{return e.scope.getProgramParent().path.hub.file.opts.filename.replace(/\\/g,"/")}catch(e){return"unknown"}}(e)),console.log(t),console.log()}function g(e,n){const t=e.indexOf(n);return-1!==t&&e.splice(t,1),e}const f=Object.keys,y=new Set(["onabort","onafterprint","onanimationcancel","onanimationend","onanimationiteration","onanimationstart","onauxclick","onbeforeinput","onbeforeprint","onbeforetoggle","onbeforeunload","onblur","oncancel","oncanplay","oncanplaythrough","onchange","onclick","onclose","oncompositionend","oncompositionstart","oncompositionupdate","oncontextlost","oncontextmenu","oncontextrestored","oncopy","oncuechange","oncut","ondblclick","ondoubleclick","ondrag","ondragend","ondragenter","ondragexit","ondragleave","ondragover","ondragstart","ondrop","ondurationchange","onemptied","onencrypted","onended","onenterpictureinpicture","onerror","onfocus","onfocusin","onfocusout","onformdata","onfullscreenchange","onfullscreenerror","ongamepadconnected","ongamepaddisconnected","ongotpointercapture","onhashchange","oninput","oninvalid","onkeydown","onkeypress","onkeyup","onlanguagechange","onleavepictureinpicture","onload","onloadeddata","onloadedmetadata","onloadstart","onlostpointercapture","onmessage","onmessageerror","onmiddleclick","onmousedown","onmouseenter","onmouseleave","onmousemove","onmouseout","onmouseover","onmouseup","onoffline","ononline","onpagehide","onpagereveal","onpageshow","onpageswap","onpaste","onpause","onplay","onplaying","onpointercancel","onpointerdown","onpointerenter","onpointerleave","onpointermove","onpointerout","onpointerover","onpointerup","onpopstate","onprogress","onratechange","onrejectionhandled","onreset","onresize","onscroll","onscrollend","onsearch","onsecuritypolicyviolation","onseeked","onseeking","onselect","onselectionchange","onselectstart","onslotchange","onstalled","onstorage","onsubmit","onsuspend","ontimeupdate","ontoggle","ontouchcancel","ontouchend","ontouchmove","ontouchstart","ontransitioncancel","ontransitionend","ontransitionrun","ontransitionstart","onunhandledrejection","onunload","onvolumechange","onwaiting","onwaitingforkey","onwebkitanimationend","onwebkitanimationiteration","onwebkitanimationstart","onwebkittransitionend","onwheel"]),h=new Set(["area","base","basefont","bgsound","br","col","command","embed","frame","hr","img","input","keygen","link","menuitem","meta","param","source","track","wbr"]);function b(e){return h.has(e)}const v=(()=>{const e={"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"},n=/[&<>'"]/g,t=n=>e[n];return function(e){return e.replace(n,t)}})();function x(e,n,t){""!==t.trim()?/"|'|=|<|>|`|\s/.test(t)?e.content+=" "+n+"='"+L(t)+"'":e.content+=" "+n+"="+t:e.content+=" "+n}function w(n){return e.types.isBooleanLiteral(n.value)&&"false"===S(n)||e.types.isBooleanLiteral(n.value?.expression)&&"false"===S(n)}function S(n){return null===n.value?"":e.types.isStringLiteral(n.value.expression)||e.types.isBooleanLiteral(n.value.expression)||e.types.isNumericLiteral(n.value.expression)?String(n.value.expression.value):String(n.value.value)}const L=(()=>{const e={"'":"&#39;",'"':"&quot;"},n=/['"]/g,t=n=>e[n];return function(e){return e.replace(n,t)}})();function k(n,t){const o=n.reduce(E,[]);if(t&&t.length>0&&o.push(function(n){let t;if(1===n.length)t=n[0];else{if(!(n.length>1))return;t=e.types.arrayExpression(n)}return e.types.objectProperty(e.types.identifier("children"),t)}(t)),o.length)return e.types.objectExpression(function(e){e&&e.sort(((e,n)=>"children"===e.key?.name?2:e.key?.name?.localeCompare(n.key?.name)));return e}(o))}function E(n,t){if(t="node"in t?t.node:t,e.types.isJSXSpreadAttribute(t)){const o=t.argument;return e.types.isObjectExpression(o)&&!j(o)?n.push(...o.properties):n.push(e.types.spreadElement(o)),n}const o=(r=t.value||e.types.booleanLiteral(!0),e.types.isJSXExpressionContainer(r)?r.expression:r);var r,a;e.types.isStringLiteral(o)&&!e.types.isJSXExpressionContainer(t.value)&&(o.value=o.value.replace(/\n\s+/g," "),null==(a=o.extra)||delete a.raw);return e.types.isJSXNamespacedName(t.name)?t.name=e.types.stringLiteral(t.name.namespace.name+":"+t.name.name.name):e.types.isValidIdentifier(t.name.name,!1)?t.name.type="Identifier":t.name=e.types.stringLiteral(t.name.name),n.push(e.types.inherits(e.types.objectProperty(t.name,o),t)),n}const j=n=>n.properties.some((n=>e.types.isObjectProperty(n,{computed:!1,shorthand:!1})&&(e.types.isIdentifier(n.key,{name:"__proto__"})||e.types.isStringLiteral(n.key,{value:"__proto__"}))));function N(n){const t=n.get("openingElement"),o=P(t.node.name,t.node);let r;return e.types.isIdentifier(o)?r=o.name:e.types.isStringLiteral(o)&&(r=o.value),e.types.react.isCompatTag(r)?r:""}function P(n,t){return e.types.isJSXIdentifier(n)?"this"===n.name&&e.types.isReferenced(n,t)?e.types.thisExpression():e.types.isValidIdentifier(n.name,!1)?(n.type="Identifier",n):e.types.stringLiteral(n.name):e.types.isJSXMemberExpression(n)?e.types.memberExpression(P(n.object,n),P(n.property,n)):e.types.isJSXNamespacedName(n)?e.types.stringLiteral(`${n.namespace.name}:${n.name.name}`):n}const X=r.parse("<!DOCTYPE html><html><head></head><body></body></html>").childNodes[1].childNodes[1];function C(e,n){let t=n.replace(/^[^<]+/,"#text").replace(/[^>]+$/,"#text").replace(/>[^<]+</gi,">#text<").replace(/\s[a-z0-9-]+="[^"]+"/gi,"").replace(/\s[a-z0-9-]+='[^']+'/gi,"").replace(/<([a-z0-9-:]+)\s+[^>]+>/gi,"<$1>");/^<(td|th)>/.test(t)&&(t=`<table><tbody><tr>${t}</tr></tbody></table>`),/^<tr>/.test(t)&&(t=`<table><tbody>${t}</tbody></table>`),/^<col>/.test(t)&&(t=`<table><colgroup>${t}</colgroup></table>`),/^<(thead|tbody|tfoot|colgroup|caption)>/.test(t)&&(t=`<table>${t}</table>`);const o=(a=t,r.serialize(r.parseFragment(X,a)));var a;o!==t&&(console.warn("-".repeat(80)),console.warn("User HTML:\n",t),console.warn("Browser HTML:\n",o),console.warn("Original HTML:\n",n),m(e,"\nThe HTML provided is malformed and will yield unexpected output when evaluated by a browser."))}const $=i.types;function J(n,t){const o=N(n),r={tagName:o,content:`<${o}`,props:[]};let a=!1,i="";const s=[(l="#pota",p="",e.types.jSXAttribute(e.types.jSXIdentifier(l),e.types.stringLiteral(p)))];var l,p,u;for(const t of n.get("openingElement").get("attributes")){if(t.isJSXAttribute()&&$.isJSXIdentifier(t.node.name)){const n=t.node.name.name;if(y.has(n.toLowerCase())&&d(t,`´${n}´ form is deprecated, use ´${n.toLowerCase().replace("on","on:")}´ instead`),!o.includes("-")&&("xmlns"===n&&(a=!0),u=t.node,e.types.isStringLiteral(u.value)||e.types.isNumericLiteral(u.value)||e.types.isBooleanLiteral(u.value)||e.types.isStringLiteral(u.value?.expression)||e.types.isNumericLiteral(u.value?.expression)||e.types.isBooleanLiteral(u.value?.expression)||null===u.value)){if("xmlns"===n){i=S(t.node);continue}if("textarea"===o&&"value"===n);else if(!/[A-Z]/.test(n)){if(w(t.node))continue;x(r,n,S(t.node));continue}}}s.push(t)}switch(o){case"svg":a=!0,i="http://www.w3.org/2000/svg";break;case"math":a=!0,i="http://www.w3.org/1998/Math/MathML"}b(o)?r.content+=" />":r.content+=">";let m=$.react.buildChildren(n.node);m=function(e,n){const t=[];for(let o=0;o<e.length;o++){const r=e[o];if(_(r))n.content+=q(r),t.push(r);else{if(!I(r))break;n.content+=O(r),n.props.push(...r.arguments[1].elements),t.push(r)}}return e.filter((e=>!t.includes(e)))}(m,r),m=M(m),r.props.unshift(k(s,m)),b(o)||(r.content+=`</${o}>`);const g=c(t,"createPartial",[$.stringLiteral(r.content),$.arrayExpression(r.props)]);return g.isPartial=!0,g.isXML=a,g.xmlns=i,g.tagName=o,g}function I(e){return e.isPartial&&!e.isXML}function O(e){return e.arguments[0].value}function M(e){const n=[];let t=0,o=e[t],r=e[++t];for(;o&&r;){if(_(o)){if(_(r)){o.value+=q(r),n.push(r),r=e[++t];continue}if(I(r)){r.arguments[0].value=q(o)+O(r),n.push(o),o=r,r=e[++t];continue}}if(I(o)){if(_(r)){o.arguments[0].value+=q(r),n.push(r),r=e[++t];continue}if(I(r)){o.arguments[0].value+=O(r),o.arguments[1].elements.push(...r.arguments[1].elements),n.push(r),r=e[++t];continue}}o=r,r=e[++t]}return e.filter((e=>!n.includes(e)))}function z(n){return M(e.types.react.buildChildren(n.node))}function _(n){return e.types.isStringLiteral(n)||e.types.isNumericLiteral(n)||e.types.isStringLiteral(n.value?.expression)||e.types.isNumericLiteral(n.value?.expression)}function q(n){return e.types.isStringLiteral(n.value?.expression)||e.types.isNumericLiteral(n.value?.expression)?v(n.value?.expression.value):v(n.value)}function A(n,t){const o=k(n.get("openingElement").get("attributes"),z(n)),r=function(e){const n=e.get("openingElement");return P(n.node.name,n.node)}(n),a=function(n){const t=n.get("openingElement"),o=P(t.node.name,t.node);if(e.types.isIdentifier(o))return o.name;if(e.types.isStringLiteral(o))return o.value;if(e.types.isMemberExpression(o))return o.object.name+"."+o.property.name;throw console.error(o),n.buildCodeFrameError("Cannot figure out `tagName` for JSX function.")}(n),i=n.scope;i.pota=i.pota||{partials:{},components:{},files:{}};const s=i.pota;if(!s.components[a]){s.components[a]=i.generateUidIdentifier(a);const n=s.components[a],o=c(t,"createComponent",[r]),l=i.getBinding(a);switch(l?.kind){case"module":l.path.parentPath.insertAfter(e.types.variableDeclaration("const",[e.types.variableDeclarator(n,o)]));break;case"const":case"let":l.path.getStatementParent().insertAfter(e.types.variableDeclaration("const",[e.types.variableDeclarator(n,o)]));break;default:i.push({id:n,init:o})}}return u(s.components[a].name,o?[o]:[])}function B({name:o}){return n.declare(((n,r)=>({name:o,inherits:t.default,visitor:{JSXNamespacedName(e){},JSXSpreadChild(e){m(e,"Spread children are not supported.")},Program:{enter(e,n){n.pota={partials:{},components:{},files:{}},p(e,n,"createPartial"),p(e,n,"createComponent")},exit(n,t){n.traverse({CallExpression(n,t){if(n.node.isPartial){const o=function(e,n){const t=e.node,o=t.arguments[1].elements,r={};let a=0;const s=[];for(let e=0;e<o.length;e++){const n=o[e].properties,t=n.find((e=>"#pota"===e.key.value));t&&g(n,t),n.length?(a!==e&&(r[a]=e),a++):s.push(o[e])}r[a-1]>-1&&(r.m=r[a-1]+1);for(const e of s)g(o,e);0===t.arguments[1].elements.length&&g(t.arguments,t.arguments[1]);const l=O(t),p=e.scope.getProgramParent();p.pota=p.pota||{partials:{},components:{},files:{}};const m=p.pota;if(!m.partials[l]){C(e,l),m.partials[l]=p.generateUidIdentifier(t.tagName);const o=[t.arguments[0]];t.xmlns&&(r.x=t.xmlns),(/<\/[a-z0-9]+-[a-z0-9]+>/.test(l)||/<[a-z]+[^>]+is=[^>]+>/.test(l)||/<(img|iframe)[^>]+>/.test(l))&&(r.i=1),f(r).length&&o.push(i.template.expression.ast`${JSON.stringify(r)}`),p.push({id:m.partials[l],init:c(n,"createPartial",o)})}return u(m.partials[l].name,t.arguments[1]?[t.arguments[1]]:[])}(n,t);n.replaceWith(e.types.inherits(o,n.node))}}},t)}},JSXFragment:{exit(n,t){const o=function(n){const t=z(n);return 1===t.length?t[0]:t.length>1?e.types.arrayExpression(t):void 0}(n);n.replaceWith(e.types.inherits(o,n.node))}},JSXElement:{exit(n,t){const o=N(n)?J(n,t):A(n,t);n.replaceWith(e.types.inherits(o,n.node))}},JSXAttribute(n){e.types.isJSXElement(n.node.value)&&(n.node.value=e.types.jsxExpressionContainer(n.node.value))}}})))}module.exports=function(e,n={development:!1}){return{plugins:[[B({name:"transform-pota-jsx"}),n]]}};
